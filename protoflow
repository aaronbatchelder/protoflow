#!/bin/bash

# ProtoFlow - Prototype multiple approaches in parallel
# Usage: protoflow [options] or just protoflow for interactive mode

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m' # No Color

# Config
PROTOFLOW_DIR="$HOME/.protoflow"
mkdir -p "$PROTOFLOW_DIR/sessions"

# Check for required tools
if ! command -v claude &> /dev/null; then
  echo -e "${RED}Error: claude CLI is required but not installed${NC}"
  echo "Install from: https://claude.ai/code"
  exit 1
fi

# Parse arguments
PROMPT=""
REPO=""
APPROACHES=()
INTERACTIVE=false

while [[ $# -gt 0 ]]; do
  case $1 in
    --repo|-r)
      REPO="$2"
      shift 2
      ;;
    --approach|-a)
      APPROACHES+=("$2")
      shift 2
      ;;
    --help|-h)
      echo "ProtoFlow - Prototype multiple approaches in parallel"
      echo ""
      echo "Usage: protoflow                                    # Interactive mode"
      echo "       protoflow \"prompt\" --repo PATH --approach A --approach B"
      echo ""
      echo "Options:"
      echo "  --repo, -r       Path to git repository"
      echo "  --approach, -a   Constraint for an approach (can be repeated)"
      echo "  --help, -h       Show this help message"
      echo ""
      echo "Example:"
      echo "  protoflow \"Add user authentication\" \\"
      echo "    --repo ~/projects/myapp \\"
      echo "    --approach \"Use Passport.js with sessions\" \\"
      echo "    --approach \"Use JWT tokens\""
      exit 0
      ;;
    *)
      if [[ -z "$PROMPT" ]]; then
        PROMPT="$1"
      fi
      shift
      ;;
  esac
done

# If missing required args, go interactive
if [[ -z "$PROMPT" ]] || [[ -z "$REPO" ]] || [[ ${#APPROACHES[@]} -lt 2 ]]; then
  INTERACTIVE=true
fi

# Interactive mode
if [[ "$INTERACTIVE" == true ]]; then
  clear
  echo ""
  echo -e "${DIM}══════════════════════════════════════════════════════════════════════════════════${NC}"
  echo -e "${CYAN}"
  cat << 'EOF'
      ____             __       ________
     / __ \_________  / /_____  / ____/ /___ _      __
    / /_/ / ___/ __ \/ __/ __ \/ /_  / / __ \ | /| / /
   / ____/ /  / /_/ / /_/ /_/ / __/ / / /_/ / |/ |/ /
  /_/   /_/   \____/\__/\____/_/   /_/\____/|__/|__/
EOF
  echo -e "${NC}"
  echo -e "  ${DIM}Prototype multiple approaches in parallel. Merge the best one.${NC}"
  echo ""
  echo -e "${DIM}══════════════════════════════════════════════════════════════════════════════════${NC}"
  echo ""

  # Step 1: Project
  if [[ -z "$REPO" ]]; then
    echo -e "${CYAN}${BOLD}Select your project to get started${NC}"
    echo ""

    # Check if we're in a git repo
    if git rev-parse --git-dir &>/dev/null; then
      CURRENT_DIR="$(pwd)"
      REPO_NAME=$(basename "$CURRENT_DIR")

      echo -e "  ${GREEN}→${NC} You're in: ${CYAN}$CURRENT_DIR${NC}"
      echo ""
      echo -e "  ${YELLOW}1${NC}) Use current repo: ${BOLD}$REPO_NAME${NC} ${DIM}(default)${NC}"
      echo -e "  ${YELLOW}2${NC}) Enter a different path"
      echo -e "  ${YELLOW}3${NC}) Create a new project"
      echo ""
      echo -e -n "Enter choice (1-3): "
      read -r CHOICE
      CHOICE="${CHOICE:-1}"

      case "$CHOICE" in
        1)
          REPO="$CURRENT_DIR"
          ;;
        2)
          echo -e -n "${YELLOW}Project path${NC}: "
          read -r REPO
          REPO="${REPO/#\~/$HOME}"
          ;;
        3)
          echo -e -n "${YELLOW}New project name${NC}: "
          read -r PROJECT_NAME
          REPO="$HOME/projects/$PROJECT_NAME"
          echo -e "${DIM}Will create: $REPO${NC}"
          ;;
        *)
          REPO="$CURRENT_DIR"
          ;;
      esac
    else
      # Not in a git repo
      echo -e "  ${DIM}You're in: $(pwd) (not a git repo)${NC}"
      echo ""
      echo -e "  ${YELLOW}1${NC}) Enter path to existing repo ${DIM}(default)${NC}"
      echo -e "  ${YELLOW}2${NC}) Create a new project"
      echo ""
      echo -e -n "Enter choice (1-2): "
      read -r CHOICE
      CHOICE="${CHOICE:-1}"

      case "$CHOICE" in
        1)
          echo -e -n "${YELLOW}Project path${NC}: "
          read -r REPO
          REPO="${REPO/#\~/$HOME}"
          ;;
        2)
          echo -e -n "${YELLOW}New project name${NC}: "
          read -r PROJECT_NAME
          REPO="$HOME/projects/$PROJECT_NAME"
          echo -e "${DIM}Will create: $REPO${NC}"
          ;;
        *)
          echo -e -n "${YELLOW}Project path${NC}: "
          read -r REPO
          REPO="${REPO/#\~/$HOME}"
          ;;
      esac
    fi
  fi

  # Validate repo - offer to create if doesn't exist
  if [[ ! -d "$REPO" ]]; then
    echo ""
    echo -e "${YELLOW}Directory doesn't exist: $REPO${NC}"
    echo -e -n "Create it as a new git repository? [Y/n]: "
    read -r CREATE_REPO
    if [[ "$CREATE_REPO" =~ ^[Nn] ]]; then
      echo -e "${RED}Cancelled${NC}"
      exit 1
    fi
    mkdir -p "$REPO"
    git -C "$REPO" init --quiet
    echo -e "${GREEN}✓${NC} Created new git repository"
  elif [[ ! -d "$REPO/.git" ]]; then
    echo ""
    echo -e "${YELLOW}Directory exists but is not a git repository${NC}"
    echo -e -n "Initialize git in $REPO? [Y/n]: "
    read -r INIT_GIT
    if [[ "$INIT_GIT" =~ ^[Nn] ]]; then
      echo -e "${RED}Cancelled${NC}"
      exit 1
    fi
    git -C "$REPO" init --quiet
    echo -e "${GREEN}✓${NC} Initialized git repository"
  fi

  echo -e "${GREEN}✓${NC} Using repository: ${REPO}"
  echo ""

  # Step 2: Task
  if [[ -z "$PROMPT" ]]; then
    echo -e "${CYAN}${BOLD}Step 2: Task${NC}"
    echo -e "${DIM}What do you want to build? Describe the feature or task.${NC}"
    echo ""
    echo -e -n "${YELLOW}Task description${NC}: "
    read -r PROMPT

    if [[ -z "$PROMPT" ]]; then
      echo -e "${RED}Error: Task description is required${NC}"
      exit 1
    fi
  fi

  echo -e "${GREEN}✓${NC} Task: ${PROMPT}"
  echo ""

  # Step 3: Approaches
  if [[ ${#APPROACHES[@]} -lt 2 ]]; then
    echo -e "${CYAN}${BOLD}Step 3: Approaches${NC}"
    echo -e "${DIM}Define 2+ different approaches to explore in parallel.${NC}"
    echo -e "${DIM}Examples: ${NC}${YELLOW}\"Use Redux\"${NC}${DIM}, ${NC}${YELLOW}\"Use Zustand\"${NC}${DIM}, ${NC}${YELLOW}\"Minimalist design\"${NC}"
    echo ""

    APPROACHES=()
    APPROACH_NUM=1

    while true; do
      LABEL="A"
      if [[ $APPROACH_NUM -eq 2 ]]; then LABEL="B"; fi
      if [[ $APPROACH_NUM -eq 3 ]]; then LABEL="C"; fi
      if [[ $APPROACH_NUM -eq 4 ]]; then LABEL="D"; fi

      if [[ $APPROACH_NUM -le 2 ]]; then
        echo -e -n "${YELLOW}Approach $LABEL${NC}: "
      else
        echo -e -n "${YELLOW}Approach $LABEL${NC} ${DIM}(or Enter to start)${NC}: "
      fi

      read -r APPROACH_INPUT

      if [[ -z "$APPROACH_INPUT" ]]; then
        if [[ $APPROACH_NUM -le 2 ]]; then
          echo -e "${RED}Need at least 2 approaches${NC}"
          continue
        else
          break
        fi
      fi

      APPROACHES+=("$APPROACH_INPUT")
      APPROACH_NUM=$((APPROACH_NUM + 1))

      if [[ $APPROACH_NUM -gt 4 ]]; then
        echo -e "${DIM}Maximum 4 approaches reached${NC}"
        break
      fi
    done
  fi

  echo ""
  echo -e "${GREEN}✓${NC} Running ${#APPROACHES[@]} approaches in parallel:"
  for i in "${!APPROACHES[@]}"; do
    LETTERS=("A" "B" "C" "D")
    echo -e "   ${CYAN}${LETTERS[$i]}${NC}: ${APPROACHES[$i]}"
  done
  echo ""

  # Confirm
  echo -e -n "${DIM}Press ${NC}${BOLD}Enter${NC}${DIM} to start or ${NC}${BOLD}Ctrl+C${NC}${DIM} to cancel...${NC} "
  read -r
  echo ""
fi

# Validate inputs (for non-interactive mode)
if [[ ! -d "$REPO" ]]; then
  echo -e "${RED}Error: Project path does not exist: $REPO${NC}"
  exit 1
fi

if [[ ! -d "$REPO/.git" ]]; then
  echo -e "${RED}Error: Not a git repository: $REPO${NC}"
  exit 1
fi

if [[ ${#APPROACHES[@]} -lt 2 ]]; then
  echo -e "${RED}Error: Need at least 2 approaches${NC}"
  exit 1
fi

# Generate session ID
SESSION_ID=$(date +%Y%m%d-%H%M%S)
SESSION_DIR="$PROTOFLOW_DIR/sessions/$SESSION_ID"
mkdir -p "$SESSION_DIR"

echo -e "${CYAN}${BOLD}Starting ProtoFlow...${NC}"
echo ""
echo -e "${DIM}Task:${NC} $PROMPT"
echo -e "${DIM}Project:${NC} $REPO"
echo -e "${DIM}Session:${NC} $SESSION_ID"
echo ""

# Create worktrees for each approach
WORKTREES=()
LETTERS=("A" "B" "C" "D")

# Check if this is an existing repo with code or a new/empty repo
FILE_COUNT=$(find "$REPO" -maxdepth 2 -type f \( -name "*.js" -o -name "*.ts" -o -name "*.py" -o -name "*.go" -o -name "*.rs" -o -name "*.java" -o -name "*.rb" -o -name "*.php" -o -name "*.swift" -o -name "*.kt" -o -name "*.c" -o -name "*.cpp" -o -name "*.h" -o -name "*.cs" -o -name "*.vue" -o -name "*.svelte" -o -name "*.tsx" -o -name "*.jsx" -o -name "package.json" -o -name "Cargo.toml" -o -name "go.mod" -o -name "requirements.txt" -o -name "Gemfile" -o -name "pom.xml" \) 2>/dev/null | wc -l | tr -d ' ')

if [[ "$FILE_COUNT" -gt 0 ]]; then
  IS_EXISTING_REPO=true
  echo -e "${DIM}Detected existing codebase ($FILE_COUNT source files)${NC}"
else
  IS_EXISTING_REPO=false
  echo -e "${DIM}Starting with empty/new repository${NC}"
fi

for i in "${!APPROACHES[@]}"; do
  LETTER="${LETTERS[$i]}"
  LETTER_LOWER=$(echo "$LETTER" | tr '[:upper:]' '[:lower:]')
  CONSTRAINT="${APPROACHES[$i]}"
  BRANCH_NAME="protoflow/$SESSION_ID/approach-$LETTER_LOWER"
  WORKTREE_PATH="$SESSION_DIR/approach-$LETTER_LOWER"

  echo -e "${DIM}Creating workspace for Approach $LETTER...${NC}"

  # Create worktree
  git -C "$REPO" worktree add "$WORKTREE_PATH" -b "$BRANCH_NAME" 2>/dev/null || \
    git -C "$REPO" worktree add "$WORKTREE_PATH" "$BRANCH_NAME" 2>/dev/null

  # Assign unique port for this approach (starting at 4000 to avoid common defaults)
  DEV_PORT=$((4000 + i))

  # Create PROMPT.md with different instructions based on repo state
  if [[ "$IS_EXISTING_REPO" == true ]]; then
    cat > "$WORKTREE_PATH/PROMPT.md" << EOF
# Task

$PROMPT

## Approach

$CONSTRAINT

## Instructions

This is an existing codebase. Before making any changes:

1. **Explore the codebase** - Understand the project structure, tech stack, and existing patterns
2. **Review relevant files** - Read the code that relates to your task
3. **Plan your approach** - Decide how to implement the task while following existing conventions
4. **Implement** - Make changes that integrate cleanly with the existing code

Work autonomously until the task is complete.

## IMPORTANT: Dev Server Port

You MUST use port $DEV_PORT for any dev server. Other approaches are running in parallel on different ports.

Configure your dev server to use port $DEV_PORT (e.g., \`vite --port $DEV_PORT\`, \`next dev -p $DEV_PORT\`, \`PORT=$DEV_PORT npm start\`).

If this project has a web UI, run \`open http://localhost:$DEV_PORT\` to launch the browser after starting the dev server.
EOF
  else
    cat > "$WORKTREE_PATH/PROMPT.md" << EOF
# Task

$PROMPT

## Approach

$CONSTRAINT

## Instructions

This is a new project. Build it from scratch following the specified approach.
Work autonomously until the task is complete.

## IMPORTANT: Dev Server Port

You MUST use port $DEV_PORT for any dev server. Other approaches are running in parallel on different ports.

Configure your dev server to use port $DEV_PORT (e.g., \`vite --port $DEV_PORT\`, \`next dev -p $DEV_PORT\`, \`PORT=$DEV_PORT npm start\`).

If this project has a web UI, run \`open http://localhost:$DEV_PORT\` to launch the browser after starting the dev server.
EOF
  fi

  WORKTREES+=("$WORKTREE_PATH")
  echo -e "${GREEN}  ✓${NC} Approach $LETTER ready"
done

echo ""
echo -e "${DIM}Launching Claude agents...${NC}"
echo ""

# Launch each approach in a separate Terminal window
INITIAL_PROMPT="Read PROMPT.md and implement the task. Work autonomously until complete."

# Detect the terminal emulator and OS
launch_terminal() {
  local worktree="$1"
  local letter="$2"
  local prompt="$3"
  local port="$4"

  # Create a launcher script for this approach
  local launcher="$worktree/.protoflow-launcher.sh"
  cat > "$launcher" << LAUNCHER
#!/bin/bash
cd "$worktree"

# Kill any existing process on this port
if lsof -ti:$port &>/dev/null; then
  echo -e "\033[0;33mKilling existing process on port $port...\033[0m"
  lsof -ti:$port | xargs kill -9 2>/dev/null
  sleep 1
fi

echo -e "\033[0;36m╔══════════════════════════════════════════════════════════════╗\033[0m"
echo -e "\033[0;36m║  ProtoFlow - Approach $letter                                    ║\033[0m"
echo -e "\033[0;36m║  Session: $SESSION_ID                              ║\033[0m"
echo -e "\033[0;36m╚══════════════════════════════════════════════════════════════╝\033[0m"
echo ""
echo -e "\033[2mWorking directory: $worktree\033[0m"
echo -e "\033[2mAssigned port: $port\033[0m"
echo ""
claude --dangerously-skip-permissions "$prompt"
LAUNCHER
  chmod +x "$launcher"

  if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS - use Terminal.app or iTerm if available
    if [[ -d "/Applications/iTerm.app" ]]; then
      osascript << EOF
tell application "iTerm"
  create window with default profile
  tell current session of current window
    write text "cd \"$worktree\" && bash .protoflow-launcher.sh"
  end tell
end tell
EOF
    else
      osascript << EOF
tell application "Terminal"
  do script "cd \"$worktree\" && bash .protoflow-launcher.sh"
  activate
end tell
EOF
    fi
  elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    # Linux - try common terminal emulators
    if command -v gnome-terminal &> /dev/null; then
      gnome-terminal --working-directory="$worktree" -- bash .protoflow-launcher.sh &
    elif command -v konsole &> /dev/null; then
      konsole --workdir "$worktree" -e bash .protoflow-launcher.sh &
    elif command -v xterm &> /dev/null; then
      xterm -e "cd '$worktree' && bash .protoflow-launcher.sh" &
    else
      echo -e "${RED}No supported terminal emulator found${NC}"
      echo "Please manually run: cd '$worktree' && claude '$prompt'"
    fi
  else
    echo -e "${YELLOW}Unsupported OS. Please manually run in each directory:${NC}"
    echo "cd '$worktree' && claude '$prompt'"
  fi
}

# Launch terminal for each approach
for i in "${!WORKTREES[@]}"; do
  LETTER="${LETTERS[$i]}"
  PORT=$((4000 + i))
  echo -e "${GREEN}▶${NC} Launching Approach $LETTER in new terminal window..."
  launch_terminal "${WORKTREES[$i]}" "$LETTER" "$INITIAL_PROMPT" "$PORT"
  sleep 1  # Small delay between launches
done

echo ""
echo -e "${GREEN}${BOLD}All agents launched!${NC}"
echo ""
echo -e "  ${DIM}Each approach is running in its own terminal window.${NC}"
echo -e "  ${DIM}Switch between windows using Cmd+\` (macOS) or Alt+Tab (Linux).${NC}"
echo ""
echo -e "${CYAN}${BOLD}Session Info:${NC}"
echo -e "  ${DIM}Session ID:${NC}  $SESSION_ID"
echo -e "  ${DIM}Workspaces:${NC}  $SESSION_DIR"
echo ""
echo -e "${CYAN}${BOLD}Branches created:${NC}"
for i in "${!APPROACHES[@]}"; do
  LETTER="${LETTERS[$i]}"
  LETTER_LOWER=$(echo "$LETTER" | tr '[:upper:]' '[:lower:]')
  echo -e "  ${CYAN}$LETTER${NC}: protoflow/$SESSION_ID/approach-$LETTER_LOWER"
done
echo ""
echo -e "${DIM}When finished, merge your preferred approach:${NC}"
echo -e "  git merge protoflow/$SESSION_ID/approach-a  ${DIM}# or b, c, d${NC}"
echo ""
